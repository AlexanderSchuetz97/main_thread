name: Rust

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: cargo fmt
        run: cargo fmt --check
  clippy-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: clippy
        run: cargo clippy -- --deny warnings
  clippy-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: clippy
        run: cargo clippy -- --deny warnings
  linux-no-std:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Add nightly toolchain
        run: rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu
      - name: no-std build
        run: cargo clean && cargo +nightly -Zbuild-std=core build
  windows-no-std:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Add nightly toolchain
        run: rustup component add rust-src --toolchain nightly-x86_64-pc-windows-msvc
      - name: no-std build
        run: cargo clean && cargo +nightly -Zbuild-std=core build
  macos-no-std:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Add nightly toolchain
        run: rustup component add rust-src --toolchain nightly-aarch64-apple-darwin
      - name: no-std build
        run: cargo clean && cargo +nightly -Zbuild-std=core build
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test Binary
        run: cargo run --example test
      - name: Test Shared object
        run: cd dll_test_crate && cargo build && cargo run --example test
  linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - name: Test Binary
        run: cargo run --example test
      - name: Test Shared object
        run: cd dll_test_crate && cargo build && cargo run --example test
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test Binary
        run: cargo run --example test
      - name: Test Shared object
        run: cd dll_test_crate && cargo build && cargo run --example test
  windows-arm:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      - name: Test Binary
        run: cargo run --example test
      - name: Test Shared object
        run: cd dll_test_crate && cargo build && cargo run --example test
  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test Binary
        run: cargo run --example test
      - name: Test Shared object
        run: cd dll_test_crate && cargo build && cargo run --example test
  netbsd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: test netbsd
        uses: cross-platform-actions/action@v0.29.0
        with:
          memory: 1024M
          operating_system: netbsd
          version: '10.1'
          run: |
            uname -a
            ls -lah
            echo "INSTALLING CURL"
            sudo pkgin -y install curl
            echo "SETUP RUST"
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            . "$HOME/.cargo/env"
            echo "RUNNING BINARY TEST"
            cargo run --example test
            echo "RUNNING SHARED OBJECT TEST"
            cd dll_test_crate
            cargo build
            cargo run --example test
  freebsd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: test freebsd
        uses: cross-platform-actions/action@v0.29.0
        with:
          memory: 1024M
          operating_system: freebsd
          version: '14.3'
          run: |
            uname -a
            ls -lah
            echo "SETUP RUST"
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            . "$HOME/.cargo/env"
            echo "RUNNING BINARY TEST"
            cargo run --example test
            echo "RUNNING SHARED OBJECT TEST"
            cd dll_test_crate
            cargo build
            cargo run --example test
  openbsd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: test freebsd
        uses: cross-platform-actions/action@v0.29.0
        with:
          memory: 1024M
          operating_system: openbsd
          version: '7.7'
          run: |
            uname -a
            ls -lah
            echo "SETUP RUST"
            sudo pkg_add rust
            echo "RUNNING BINARY TEST"
            cargo run --example test
            echo "RUNNING SHARED OBJECT TEST"
            cd dll_test_crate
            cargo build
            cargo run --example test